
# Single-cell transcriptomic data

For use with single-cell transcriptomic data, some functions are prepared.

## Visualizing textual information for marker genes

Visualize the network for all the cluster's marker genes.


```r
library(Seurat)
library(patchwork)
library(ggraph)
library(wcGeneSummary)
library(scplot)
```


```r
dir = "filtered_gene_bc_matrices/hg19"
pbmc.data <- Read10X(data.dir = dir)
pbmc <- CreateSeuratObject(counts = pbmc.data, project = "pbmc3k",
                           min.cells=3, min.features=200)
pbmc <- NormalizeData(pbmc)
pbmc <- FindVariableFeatures(pbmc, selection.method = "vst")
pbmc <- ScaleData(pbmc, features = row.names(pbmc))
pbmc <- RunPCA(pbmc, features = VariableFeatures(object = pbmc))
pbmc <- FindNeighbors(pbmc, dims = 1:10, verbose = FALSE)
pbmc <- FindClusters(pbmc, resolution = 0.5, verbose = FALSE)
pbmc <- RunUMAP(pbmc, dims = 1:10, umap.method = "uwot", metric = "cosine")
DimPlot(pbmc, reduction = "umap",
        label = TRUE, pt.size = 0.5) 
```

<img src="07-sc_files/figure-html/sc1-1.png" width="480" />

```r
## Or, use scplot (https://yulab-smu.top/scplot/)
sc_dim(pbmc) + 
    sc_dim_geom_label(geom = shadowtext::geom_shadowtext, 
            color='black', bg.color='white')
```

<img src="07-sc_files/figure-html/sc1-2.png" width="480" />



```r
markers <- FindAllMarkers(pbmc)
texts <- markers |> TextMarkers(type="network")
#> 0
#> Input genes: 753
#>   Converted input genes: 713
#> Filter based on GeneSummary
#> Filtered 65 words (frequency and/or tfidf)
#> 1
#> Input genes: 1027
#>   Converted input genes: 968
#> Filter based on GeneSummary
#> Filtered 65 words (frequency and/or tfidf)
#> 2
#> Input genes: 409
#>   Converted input genes: 387
#> Filter based on GeneSummary
#> Filtered 65 words (frequency and/or tfidf)
#> 3
#> Input genes: 588
#>   Converted input genes: 545
#> Filter based on GeneSummary
#> Filtered 65 words (frequency and/or tfidf)
#> 4
#> Input genes: 316
#>   Converted input genes: 300
#> Filter based on GeneSummary
#> Filtered 65 words (frequency and/or tfidf)
#> 5
#> Input genes: 920
#>   Converted input genes: 869
#> Filter based on GeneSummary
#> Filtered 65 words (frequency and/or tfidf)
#> 6
#> Input genes: 532
#>   Converted input genes: 508
#> Filter based on GeneSummary
#> Filtered 65 words (frequency and/or tfidf)
#> 7
#> Input genes: 434
#>   Converted input genes: 414
#> Filter based on GeneSummary
#> Filtered 65 words (frequency and/or tfidf)
#> 8
#> Input genes: 336
#>   Converted input genes: 293
#> Filter based on GeneSummary
#> Filtered 65 words (frequency and/or tfidf)
wrap_plots(texts, nrow=3)
```

<img src="07-sc_files/figure-html/sc1_5-1.png" width="1920" />

Word clouds can also be shown.


```r
texts <- markers |> TextMarkers(type="wc")
#> 0
#> Input genes: 753
#>   Converted input genes: 713
#> Filter based on GeneSummary
#> Filtered 65 words (frequency and/or tfidf)
#> 1
#> Input genes: 1027
#>   Converted input genes: 968
#> Filter based on GeneSummary
#> Filtered 65 words (frequency and/or tfidf)
#> 2
#> Input genes: 409
#>   Converted input genes: 387
#> Filter based on GeneSummary
#> Filtered 65 words (frequency and/or tfidf)
#> 3
#> Input genes: 588
#>   Converted input genes: 545
#> Filter based on GeneSummary
#> Filtered 65 words (frequency and/or tfidf)
#> 4
#> Input genes: 316
#>   Converted input genes: 300
#> Filter based on GeneSummary
#> Filtered 65 words (frequency and/or tfidf)
#> 5
#> Input genes: 920
#>   Converted input genes: 869
#> Filter based on GeneSummary
#> Filtered 65 words (frequency and/or tfidf)
#> 6
#> Input genes: 532
#>   Converted input genes: 508
#> Filter based on GeneSummary
#> Filtered 65 words (frequency and/or tfidf)
#> 7
#> Input genes: 434
#>   Converted input genes: 414
#> Filter based on GeneSummary
#> Filtered 65 words (frequency and/or tfidf)
#> 8
#> Input genes: 336
#>   Converted input genes: 293
#> Filter based on GeneSummary
#> Filtered 65 words (frequency and/or tfidf)
wrap_plots(texts, nrow=3)
```

<img src="07-sc_files/figure-html/sc2-1.png" width="960" />


## `findMarkers()` in `scran`

Using data from `GSE101341` as an example input for `scran`.


```r
library(SingleCellExperiment)
library(scater)
library(scran)
```


```r
df <- read.table("GSE101341_CD14_umis.txt",
                 sep="\t", row.names=1,
                 header=1)
df |> dim()
#> [1] 26121  3655
sce <- SingleCellExperiment(list(counts=df))
sce ## Contains some malformed gene names...
#> class: SingleCellExperiment 
#> dim: 26121 3655 
#> metadata(0):
#> assays(1): counts
#> rownames(26121): 1-Dec 1-Mar ... mir-34;MIR34A
#>   unknown
#> rowData names(0):
#> colnames(3655): W101153 W101171 ... W503839 W503840
#> colData names(0):
#> reducedDimNames(0):
#> mainExpName: NULL
#> altExpNames(0):


set.seed(1)
lib.sf.sce <- librarySizeFactors(sce)
hist(log10(lib.sf.sce),
     xlab="Log10[Size factor]",
     col='grey80')
```

<img src="07-sc_files/figure-html/sc3-1.png" width="480" />

```r
clust.sce <- quickCluster(sce) 
sce <- computeSumFactors(sce,
                         cluster=clust.sce,
                         min.mean=0.1)
sce <- logNormCounts(sce)
top.sce <- getTopHVGs(sce, n=2000)
sce <- fixedPCA(sce, subset.row=top.sce) 
# sce <- runUMAP(sce)
nn.clusters <- clusterCells(sce, use.dimred="PCA")
colLabels(sce) <- nn.clusters
plrd <- plotReducedDim(sce, dimred="PCA", colour_by="label")
plrd
```

<img src="07-sc_files/figure-html/sc3-2.png" width="480" />

The function `TextMarkersScran` performs text fetching recursively for each cluster.


```r
marker.info <- findMarkers(sce, colLabels(sce))
texts <- marker.info |> TextMarkersScran()
#> 1
#> Input genes: 39
#>   Converted input genes: 31
#> Filter based on GeneSummary
#> Filtered 65 words (frequency and/or tfidf)
#> 2
#> Input genes: 52
#>   Converted input genes: 29
#> Filter based on GeneSummary
#> Filtered 65 words (frequency and/or tfidf)
#> 3
#> Input genes: 42
#>   Converted input genes: 32
#> Filter based on GeneSummary
#> Filtered 65 words (frequency and/or tfidf)
#> 4
#> Input genes: 43
#>   Converted input genes: 25
#> Filter based on GeneSummary
#> Filtered 65 words (frequency and/or tfidf)
#> 5
#> Input genes: 57
#>   Converted input genes: 42
#> Filter based on GeneSummary
#> Filtered 65 words (frequency and/or tfidf)
#> 6
#> Input genes: 51
#>   Converted input genes: 34
#> Filter based on GeneSummary
#> Filtered 65 words (frequency and/or tfidf)
#> 7
#> Input genes: 39
#>   Converted input genes: 22
#> Filter based on GeneSummary
#> Filtered 65 words (frequency and/or tfidf)
#> 8
#> Input genes: 54
#>   Converted input genes: 41
#> Filter based on GeneSummary
#> Filtered 65 words (frequency and/or tfidf)
#> 9
#> Input genes: 35
#>   Converted input genes: 16
#> Filter based on GeneSummary
#> Filtered 65 words (frequency and/or tfidf)
wrap_plots(texts, nrow=3)
```

<img src="07-sc_files/figure-html/sc3_5-1.png" width="960" />


## Map resulting wordcloud plots on the reduced dimension plot.

Single-cell level wordclouds can be plotted on the reduced dimension plot of cells.
The title in the wordcloud or network can be suppressed by `withTitle=FALSE`.


```r
library(dplyr)

## Make text visible
rawPlot <- plotReducedDim(sce, dimred="PCA",
                          colour_by="label",
                          point_alpha=0.4)


set.seed(5)
texts <- marker.info |> sample(2) |> TextMarkersScran(wcArgs=list(alpha=0.9),
                                                      args=list(wcScale=4),
                                                      withTitle=FALSE)
#> 2
#> Input genes: 52
#>   Converted input genes: 29
#> Filter based on GeneSummary
#> Filtered 65 words (frequency and/or tfidf)
#> 3
#> Input genes: 42
#>   Converted input genes: 32
#> Filter based on GeneSummary
#> Filtered 65 words (frequency and/or tfidf)


new_points <- rawPlot$data |>
  group_by(colour_by) |>
  summarise(XMi=min(X),
            YMi=min(Y),
            XMa=max(X),
            YMa=max(Y))

for (i in names(texts)) {
  tmp <- subset(new_points,
                new_points$colour_by==i)
  tmpXMi <- tmp$XMi; tmpYMi <- tmp$YMi; tmpXMa <- tmp$XMa; tmpYMa <- tmp$YMa
  rawPlot <- rawPlot + annotation_custom(ggplotify::as.grob(texts[[i]]),
                                   xmin=tmpXMi, xmax=tmpXMa,
                                   ymin=tmpYMi, ymax=tmpYMa)
}
rawPlot
```

<img src="07-sc_files/figure-html/plotdirect-1.png" width="480" />

A function is prepared to generate colors and show word cloud on the reduced dimension plot using the same color as the original plot (`plotReducedDimWithTexts`). This function can use `use_shadowtext` in `ggwordcloud::geom_text_wordcloud`, which is available from the forked repository (`noriakis/ggwordcloud`). `bg.colour` is used to specify background color.


```r
plotReducedDimWithTexts(sce, marker.info, colour_by="label",point_alpha=0.3,
                        use_shadowtext=TRUE, which.label=c("2","4"))
#> 2
#> Input genes: 52
#>   Converted input genes: 29
#> Filter based on GeneSummary
#> Filtered 65 words (frequency and/or tfidf)
#> 4
#> Input genes: 43
#>   Converted input genes: 25
#> Filter based on GeneSummary
#> Filtered 65 words (frequency and/or tfidf)
```

<img src="07-sc_files/figure-html/formal-1.png" width="480" />

```r

## Change the bg.colour
plotReducedDimWithTexts(sce, marker.info, colour_by="label",point_alpha=0.3,
                        use_shadowtext=TRUE, bg.colour="tomato",
                        which.label=c("3","5"))
#> 3
#> Input genes: 42
#>   Converted input genes: 32
#> Filter based on GeneSummary
#> Filtered 65 words (frequency and/or tfidf)
#> 5
#> Input genes: 57
#>   Converted input genes: 42
#> Filter based on GeneSummary
#> Filtered 65 words (frequency and/or tfidf)
```

<img src="07-sc_files/figure-html/formal-2.png" width="480" />

```r
## Change the font
## Use alien encounter fonts (http://www.hipsthetic.com/alien-encounters-free-80s-font-family/)
sysfonts::font_add(family="alien",regular="SFAlienEncounters.ttf")
showtext::showtext_auto()
plotReducedDimWithTexts(sce, marker.info, colour_by="label",point_alpha=0.3,
                        use_shadowtext=TRUE, bg.colour="white", args=list(fontFamily="alien"),
                        which.label=c("4","7"), wcScale=6)
#> 4
#> Input genes: 43
#>   Converted input genes: 25
#> Filter based on GeneSummary
#> Filtered 65 words (frequency and/or tfidf)
#> 7
#> Input genes: 39
#>   Converted input genes: 22
#> Filter based on GeneSummary
#> Filtered 65 words (frequency and/or tfidf)
```

<img src="07-sc_files/figure-html/formal-3.png" width="480" />

For the `Seurat` object, use `DimPlotWithTexts()`.


```r
r <- rep(4, length(unique(markers$cluster)))
names(r) <- unique(markers$cluster)
DimPlotWithTexts(pbmc, markers, label=FALSE, rad=r, which.label=c("2","4"),
                 wcScale=6)
#> 2
#> Input genes: 409
#>   Converted input genes: 387
#> Filter based on GeneSummary
#> Filtered 65 words (frequency and/or tfidf)
#> 4
#> Input genes: 316
#>   Converted input genes: 300
#> Filter based on GeneSummary
#> Filtered 65 words (frequency and/or tfidf)
```

<img src="07-sc_files/figure-html/formal2-1.png" width="100%" />

Give the function a data frame that is already filtered, like thersholding by adjusted p-values.


```r
r <- rep(2, length(unique(markers$cluster)))
names(r) <- unique(markers$cluster)
thresh <- subset(markers, markers$p_val_adj<1e-50)
DimPlotWithTexts(pbmc,
                 thresh,
                 label=FALSE,
                 rad=r,
                 which.label=c("2","4","6"),
                 args=list(numWords=50,scaleLowFreq=5))
#> 2
#> Input genes: 8
#>   Converted input genes: 8
#> Filter based on GeneSummary
#> Filtered 65 words (frequency and/or tfidf)
#> 4
#> Input genes: 16
#>   Converted input genes: 16
#> Filter based on GeneSummary
#> Filtered 65 words (frequency and/or tfidf)
#> 6
#> Input genes: 40
#>   Converted input genes: 39
#> Filter based on GeneSummary
#> Filtered 65 words (frequency and/or tfidf)
```

<img src="07-sc_files/figure-html/formal3-1.png" width="100%" />

`geom_sc_wordcloud` is prepared to use in conjuction with `scplot`.


```r
scplot::sc_dim(pbmc,reduction = "pca")+
  geom_sc_wordcloud(markers, show_markers = c(3,5),
                    p_val_adj_threshold = 1e-50, wcScale=7)+
  scplot::sc_dim_geom_label(geom = shadowtext::geom_shadowtext, 
                  color='black', bg.color='white')
#> 3
#> Input genes: 64
#>   Converted input genes: 60
#> Filter based on GeneSummary
#> Filtered 65 words (frequency and/or tfidf)
#> 5
#> Input genes: 88
#>   Converted input genes: 82
#> Filter based on GeneSummary
#> Filtered 65 words (frequency and/or tfidf)
```

<img src="07-sc_files/figure-html/scp-1.png" width="100%" />

Some positioning arguments are prepared.


```r
scplot::sc_dim(pbmc,reduction = "pca")+
  geom_sc_wordcloud(markers, show_markers = c(4,7),
                    p_val_adj_threshold = 1e-50,
                    wcScale=7,
                    base_dens=TRUE)
#> 4
#> Input genes: 16
#>   Converted input genes: 16
#> Filter based on GeneSummary
#> Filtered 65 words (frequency and/or tfidf)
#> 7
#> Input genes: 9
#>   Converted input genes: 8
#> Filter based on GeneSummary
#> Filtered 65 words (frequency and/or tfidf)
```

<img src="07-sc_files/figure-html/scp2-1.png" width="100%" />

## Plotting marker gene names in plot

You can plot gene names instead of gene description by specifying `gene_name=TRUE` in `geom_sc_wordcloud()`. Number of genes can be controlled with `geneNum`. The genes in each cluster are ordered by `sort_by`, in decreasing order in default (`decreasing` option).


```r
scplot::sc_dim(pbmc,reduction = "pca")+
    geom_sc_wordcloud(markers, show_markers = c(0,5),
                      gene_name = TRUE, wcScale=7,
                      p_val_adj_threshold = 1e-50, base_dens = TRUE)
```

<img src="07-sc_files/figure-html/scp3-1.png" width="100%" />

Scaling color should be called before `geom_sc_wordcloud()`.


```r
scplot::sc_dim(pbmc,reduction = "pca")+
    scale_color_manual(values=RColorBrewer::brewer.pal(9, "PuOr"))+
    geom_sc_wordcloud(markers, show_markers = c(0,5),
                      gene_name = TRUE, wcScale=7,
                      p_val_adj_threshold = 1e-50, base_dens = TRUE)
```

<img src="07-sc_files/figure-html/scp4-1.png" width="100%" />

For scran, use `plotReducedDimWithTexts`.


```r
scex <- plotReducedDimWithTexts(sce,
                        marker.info,
                        colour_by="label",
                        base_dens = TRUE,
                        point_alpha=0.3,
                        wcScale=6,
                        use_shadowtext=TRUE,
                        bg.colour="grey80",
                        gene_name=TRUE,
                        which.label=c("3","5"))
scex
```

<img src="07-sc_files/figure-html/scp5-1.png" width="100%" />

### Plotting the enrichment analysis results of marker genes


```r
r <- rep(3, length(unique(markers$cluster)))
names(r) <- unique(markers$cluster)

## Enrichment analysis
DimPlotWithTexts(pbmc, thresh, label=FALSE,
                       point_alpha = 0.8,which.label = c(0,6),
                       args=list(enrich="reactome",
                                 numWords=50),
                       reduction = "pca", base_dens=TRUE,
                       wcScale=7)
#> 0
#> Input genes: 75
#>   Converted input genes: 75
#> Filter based on GeneSummary
#> Filtered 65 words (frequency and/or tfidf)
#> Performing enrichment analysis
#> 6
#> Input genes: 40
#>   Converted input genes: 39
#> Filter based on GeneSummary
#> Filtered 65 words (frequency and/or tfidf)
#> Performing enrichment analysis
```

<img src="07-sc_files/figure-html/formal4-1.png" width="100%" />
